var SSI=SSI||{};SSI.Core3D=function(z){var o,t,C,A,B,L;var d,H;var f;var k=0;var v={x:0,y:0},s={x:0,y:0};var u={x:0,y:0},a={x:Math.PI*3/2,y:Math.PI/6},m={x:0,y:0};var q=50000,y=50000;var p=Math.PI/2;var j=500000;var i=10000;var D=new Array();var c=null;function I(){B=z.offsetWidth||window.innerWidth;L=z.offsetHeight||window.innerHeight;J();o=new THREE.PerspectiveCamera(30,B/L,1,1000000);o.position.z=q;d=new THREE.Vector3();t=new THREE.Scene();r();H()}function J(){C=new THREE.Projector();A=new THREE.WebGLRenderer({antialias:true});A.autoClear=false;A.setClearColorHex(0,0);A.setSize(B,L);A.domElement.style.position="absolute";z.appendChild(A.domElement)}function r(){z.addEventListener("mousedown",K,false);z.addEventListener("mousewheel",E,false);z.addEventListener("DOMMouseScroll",F,false);document.addEventListener("keydown",N,false);window.addEventListener("resize",g,false);z.addEventListener("mouseover",function(){f=true},false);z.addEventListener("mouseout",function(){f=false},false)}function H(){requestAnimationFrame(H);x()}function x(){G(k);u.x+=(a.x-u.x)*0.1;u.y+=(a.y-u.y)*0.1;q+=(y-q)*0.3;o.position.x=q*Math.sin(u.x)*Math.cos(u.y);o.position.y=q*Math.sin(u.y);o.position.z=q*Math.cos(u.x)*Math.cos(u.y);o.lookAt(t.position);d.copy(o.position);l();A.clear();A.render(t,o)}function l(){for(var O in D){if(D[O].scale==true){var R=D[O].shape.position;var S=R.x-o.position.x;var P=R.y-o.position.y;var h=R.z-o.position.z;var w=Math.sqrt(S*S+P*P+h*h);var Q=w/(6371*7);D[O].shape.scale.x=D[O].shape.scale.y=D[O].shape.scale.z=Q}}}function K(h){h.preventDefault();z.addEventListener("mousemove",b,false);z.addEventListener("mouseup",M,false);z.addEventListener("mouseout",e,false);s.x=-h.clientX;s.y=h.clientY;m.x=a.x;m.y=a.y;z.style.cursor="move"}function b(h){v.x=-h.clientX;v.y=h.clientY;var w=q/(35000);a.x=m.x+(v.x-s.x)*0.005*w;a.y=m.y+(v.y-s.y)*0.005*w;a.y=a.y>p?p:a.y;a.y=a.y<-p?-p:a.y}function M(h){h.preventDefault();z.removeEventListener("mousemove",b,false);z.removeEventListener("mouseup",M,false);z.removeEventListener("mouseout",e,false);z.style.cursor="auto"}function e(h){z.removeEventListener("mousemove",b,false);z.removeEventListener("mouseup",M,false);z.removeEventListener("mouseout",e,false)}function E(h){h.preventDefault();if(f){G(h.wheelDeltaY*(10))}return false}function F(h){h.preventDefault();if(f){var w=h.detail?h.detail*(-120):h.wheelDelta;G(w*(10))}return false}function N(h){switch(h.keyCode){case 38:G(3200);h.preventDefault();break;case 40:G(-3200);h.preventDefault();break}}function g(h){clearTimeout(c);c=setTimeout(function(){n()},250)}function n(){logger.debug("resize");B=z.offsetWidth||window.innerWidth;L=z.offsetHeight||window.innerHeight;o.aspect=B/L;o.updateProjectionMatrix();A.setSize(B,L)}function G(h){y-=h;y=y>j?j:y;y=y<i?i:y}this.draw=function(O,h,w){if(D[O]==undefined){logger.debug(" adding and drawing: "+O);t.add(h);D[O]={shape:h,scale:w}}};this.showObject=function(w,h){if(D[w]!=undefined){if(h){logger.debug("adding shape back to scene for id "+w);t.add(D[w].shape)}else{logger.debug("removing object from scene with id: "+w);t.remove(D[w].shape)}}};this.removeObject=function(h){if(D[h]!=undefined){t.remove(D[h].shape);delete D[h]}};this.removeAllObjects=function(){for(var h in D){t.remove(D[h].shape)}D=new Array()};this.getObjectPosition=function(h){if(D[h]==undefined){return undefined}return D[h].shape.position};this.moveCameraTo=function(O){logger.debug("Moving camera to: "+JSON.stringify(O));y=O.length();var w=new THREE.Vector3(0,0,1);var Q=new THREE.Vector3(0,1,0);var P=new THREE.Vector3();P.copy(O);P.y=0;P.normalize();O.normalize();var R=(Math.PI/2)-Math.acos(Q.dot(O));var h=Math.acos(w.dot(P));if(P.x<0){h=-h}a.y=isNaN(R)?0:R;a.x=isNaN(h)?0:h;logger.debug("target: "+JSON.stringify(a))};I();return this};var SSI=SSI||{};SSI.EarthExtensions=function(g){var b=this;var c=6371;var h=new THREE.Vector3(0,0,0);var f=undefined;g.setObjectInLibrary("default_ground_object_geometry",new THREE.SphereGeometry(300,20,10));g.setObjectInLibrary("default_ground_object_material",new THREE.MeshLambertMaterial({color:52224}));g.setObjectInLibrary("default_ground_track_material",new THREE.MeshBasicMaterial({color:13369344,transparent:true,opacity:0.4,blending:THREE.AdditiveBlending}));g.setObjectInLibrary("default_sensor_projection_material",new THREE.MeshBasicMaterial({color:16755200,transparent:true,blending:THREE.AdditiveBlending,overdraw:true,opacity:0.15}));g.setObjectInLibrary("default_orbit_line_material",new THREE.LineBasicMaterial({color:10027008,opacity:1}));g.setObjectInLibrary("default_ground_object_tracing_line_material",new THREE.LineBasicMaterial({color:39168,opacity:1}));this.addEarth=function(p){var o=40,m=30;var n=new THREE.SphereGeometry(c,o,m);var k={uniforms:{texture:{type:"t",value:0,texture:null}},vertexShader:["varying vec3 vNormal;","varying vec2 vUv;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec3 vNormal;","varying vec2 vUv;","void main() {","vec3 diffuse = texture2D( texture, vUv ).xyz;","float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );","vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );","gl_FragColor = vec4( diffuse + atmosphere, 1.0 );","}"].join("\n")};var i=THREE.UniformsUtils.clone(k.uniforms);i.texture.texture=THREE.ImageUtils.loadTexture(p.image);var j=new THREE.ShaderMaterial({uniforms:i,vertexShader:k.vertexShader,fragmentShader:k.fragmentShader});var l=new THREE.Mesh(n,j);g.addObject({id:"earth",objectName:"earth",update:function(q){var r=CoordinateConversionTools.convertTimeToGMST(g.getCurrentUniverseTime());l.rotation.y=r*(2*Math.PI/360)},draw:function(){g.draw(this.id,l,false)}})};this.addMoon=function(r){var o=40,i=30;var j=1737.1;var q={x:-360680.9359251,y:-42332.8629642,z:-30945.6526294,x_dot:0.1634206,y_dot:-1.0634127,z_dot:0.0412856,epoch:r.epoch};var n=new THREE.SphereGeometry(j,o,i);var l={uniforms:{texture:{type:"t",value:0,texture:null}},vertexShader:["varying vec3 vNormal;","varying vec2 vUv;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","vNormal = normalize( normalMatrix * normal );","vUv = uv;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec3 vNormal;","varying vec2 vUv;","void main() {","vec3 diffuse = texture2D( texture, vUv ).xyz;","float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );","vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );","gl_FragColor = vec4( diffuse + atmosphere, 1.0 );","}"].join("\n")};var p=THREE.UniformsUtils.clone(l.uniforms);p.texture.texture=THREE.ImageUtils.loadTexture(r.image);var m=new THREE.ShaderMaterial({uniforms:p,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader});var k=new THREE.Mesh(n,m);g.addObject({id:"moon",objectName:"moon",stateVector:q,update:function(s){var v=new ECICoordinates(this.stateVector.x,this.stateVector.y,this.stateVector.z,this.stateVector.x_dot,this.stateVector.y_dot,this.stateVector.z_dot);var w=new Date(g.getCurrentUniverseTime());var s=(w.getTime()-this.stateVector.epoch.getTime())/1000;var u=OrbitPropagator.propagateOrbit(v,s,100,this.stateVector.epoch);var t=d({x:u.x,y:u.y,z:u.z});k.position={x:t.x,y:t.y,z:t.z}},draw:function(){g.draw(this.id,k,false)}})};this.addSpaceObject=function(k){var j,i;g.getObjectFromLibraryById(k.modelId,function(l){j=l;g.getObjectFromLibraryById("default_material",function(m){i=m;j.applyMatrix(new THREE.Matrix4().setRotationFromEuler(new THREE.Vector3(0,Math.PI,0)));var n=new THREE.Mesh(j,i);g.addObject({id:k.id,objectName:k.objectName,update:function(o){var p=d(k.propagator());if(p!=undefined){n.position.set(p.x,p.y,p.z);n.lookAt(h)}},draw:function(){g.draw(this.id,n,false);b.showModelForId(k.showVehicle,this.id)}});b.addPropogationLineForObject(k);b.showOrbitLineForObject(k.showPropogationLine,k.id);b.addGroundTrackPointForObject(k);b.showGroundTrackForId(k.showGroundTrackPoint,k.id);b.addSensorProjection(k);b.showSensorProjectionForId(k.showSensorProjections,k.id);b.addClosestGroundObjectTracingLine(k)})})};this.addGroundObject=function(j){var l,i,k;if(!j.modelId){j.modelId="default_ground_object_geometry";k="default_ground_object_material"}else{k="default_material"}g.getObjectFromLibraryById(j.modelId,function(m){l=m;g.getObjectFromLibraryById(k,function(o){i=o;l.applyMatrix(new THREE.Matrix4().setRotationFromEuler(new THREE.Vector3(Math.PI/2,Math.PI,0)));var n=new THREE.Mesh(l,i);g.addObject({id:j.id,objectName:j.objectName,currentLocation:undefined,update:function(r){var q=d(j.propagator());n.position.set(q.x,q.y,q.z);this.currentLocation={x:q.x,y:q.y,z:q.z};var p=new THREE.Vector3(q.x,q.y,q.z);p.multiplyScalar(1.4);n.lookAt(p)},draw:function(){g.draw(this.id,n,true)}})})})};this.addGroundTrackPointForObject=function(j){var k,i;g.getObjectFromLibraryById("default_ground_object_geometry",function(l){k=l;g.getObjectFromLibraryById("default_ground_track_material",function(n){i=n;var m=new THREE.Mesh(k,i);g.addObject({id:j.id+"_groundPoint",objectName:j.objectName,update:function(p){var q=d(j.propagator(undefined,false));if(q!=undefined){var o=new THREE.Vector3(q.x,q.y,q.z);o.multiplyScalar(c/o.length());m.position.copy(o)}},draw:function(){g.draw(this.id,m,true)}})})})};this.addPropogationLineForObject=function(j){var k,i;k=new THREE.Geometry();g.getObjectFromLibraryById("default_orbit_line_material",function(p){i=p;var r=new Date(g.getCurrentUniverseTime());var n=1440;for(var o=0;o<n;o+=5){var q=d(j.propagator(r,false));if(q!=undefined){var m=new THREE.Vector3(q.x,q.y,q.z);k.vertices.push(new THREE.Vertex(m))}r.setMinutes(r.getMinutes()+5)}var l=new THREE.Line(k,i);g.addObject({id:j.id+"_propogation",objectName:j.objectName,update:function(s){},draw:function(){g.draw(this.id,l,false)}})})};this.addSensorProjection=function(l){var m,j;var p=d(l.propagator(undefined,false));if(p!=undefined){var i=1;m=new SensorPatternGeometry(i);var n=new THREE.Vector3(p.x,p.y,p.z);var k=n.length()-c;var o=0.15;g.getObjectFromLibraryById("default_sensor_projection_material",function(q){j=q;var r=new THREE.Mesh(m,j);r.doubleSided=true;g.addObject({id:l.id+"_sensorProjection",objectName:l.objectName,update:function(t){var u=d(l.propagator(undefined,false));if(u!=undefined){var s=new THREE.Vector3(u.x,u.y,u.z);r.position.copy(s);r.scale.z=s.length()-c+200;r.scale.x=r.scale.y=r.scale.z*o;var v=new THREE.Vector3(0,0,0);r.lookAt(v)}},draw:function(){g.draw(this.id,r,false)}})})}};this.addClosestGroundObjectTracingLine=function(j){var k,i;g.getObjectFromLibraryById("default_ground_object_tracing_line_material",function(m){i=m;var l=undefined;g.addObject({id:j.id+"_controlLine",objectName:j.objectName,update:function(o){var r=d(j.propagator(undefined,false));var q=a(r);if(q!=undefined){k=new THREE.Geometry();var n=new THREE.Vector3(r.x,r.y,r.z);k.vertices.push(new THREE.Vertex(n));var p=new THREE.Vector3(q.currentLocation.x,q.currentLocation.y,q.currentLocation.z);k.vertices.push(new THREE.Vertex(p));l=new THREE.Line(k,i)}},draw:function(){g.unDraw(this.id);if(l!=undefined){g.draw(this.id,l,false);if(f!=undefined){b.showControlLineForId(f,j.id)}else{b.showControlLineForId(j.showControlLine,j.id)}}}})})};function a(i){var j=new THREE.Vector3(i.x,i.y,i.z);j.multiplyScalar(c/j.length());return e(j)}function e(m){var k=g.getGraphicsObjects();var p=undefined;var n=undefined;for(var l in k){if(k[l].currentLocation!=undefined){var j=new THREE.Vector3(k[l].currentLocation.x,k[l].currentLocation.y,k[l].currentLocation.z);var o=j.distanceTo(m);if(p==undefined||o<p){n=k[l];p=o}}}return n}this.showAllOrbitLines=function(l){var j=g.getGraphicsObjects();for(var k in j){if(j[k].id.indexOf("_propogation")!=-1){g.showObject(j[k].id,l)}}};this.showOrbitLineForObject=function(i,j){logger.debug("in show orbit lines "+i);g.showObject(j+"_propogation",i)};this.showModelForId=function(i,j){logger.debug("show/hiding vehicle model "+i);g.showObject(j,i)};this.showAllGroundTracks=function(l){var j=g.getGraphicsObjects();for(var k in j){if(j[k].id.indexOf("_groundPoint")!=-1){g.showObject(j[k].id,l)}}};this.showGroundTrackForId=function(i,j){logger.debug("show/hiding groundTrack, isEnabled: "+i+" id: "+j);g.showObject(j+"_groundPoint",i)};this.showAllSensorProjections=function(l){var j=g.getGraphicsObjects();for(var k in j){if(j[k].id.indexOf("_sensorProjection")!=-1){g.showObject(j[k].id,l)}}};this.showSensorProjectionForId=function(i,j){g.showObject(j+"_sensorProjection",i)};this.showAllControlLines=function(l){f=l;var j=g.getGraphicsObjects();for(var k in j){if(j[k].id.indexOf("_controlLine")!=-1){g.showObject(j[k].id,l)}}};this.showControlLineForId=function(i,j){g.showObject(j+"_controlLine",i)};this.removeAllExceptEarthAndMoon=function(){var j=g.getGraphicsObjects();for(var k in j){if(j[k].id!="earth"&&j[k].id!="moon"){g.removeObject(j[k].id)}}};this.setup=function(){this.removeAllExceptEarthAndMoon();g.setup()};function d(i){if(i==undefined){return undefined}return{x:-i.x,y:i.z,z:i.y}}};var SSI=SSI||{};SSI.ObjectLibrary=function(){var a=new Array();var b=0;this.addGeometryObjectFromUrl=function(f,d,e){logger.debug("Adding mesh object to library; id: ["+f+"] url: ["+d+"]");if(a[f]!=undefined){logger.debug("Object with id ["+f+"] already exists so not adding");e();return}a[f]="loading";var c=new THREE.JSONLoader();c.load({model:d,callback:function(g){a[f]=g;e()}})};this.getObjectById=function(f,e){logger.debug("Retrieving object with id ["+f+"] from library");var c=a[f];var d=this;if(c=="loading"){setTimeout(function(){d.getObjectById(f,e)},1000)}else{if(c==null){throw"Tried to retrieve object ["+f+"] from object library but didn't exist"}else{e(c)}}};this.setObject=function(d,c){a[d]=c}};var SSI=SSI||{};SSI.Universe=function(n,b){var h=new SSI.UniverseController({});var c=new SSI.Core3D(b);var m=new SSI.ObjectLibrary();var d=n.currentUniverseTime;var a=1;var l=function(){};var i=1000;var e;var j=this;m.setObject("default_geometry",new THREE.Geometry());m.setObject("default_material",new THREE.MeshFaceMaterial());function g(o){if(l!=null){l(o)}}function f(){h.addGraphicsObject({id:"simState",objectName:"simState",update:function(o){d.setTime(d.getTime()+a*o)},draw:function(){}})}function k(){var p=this;var o={};o.currentUniverseTime=new Date(d);g(o);e=setTimeout(function(){k()},i)}this.play=function(o){d=new Date(o.startTime);a=o.playbackSpeed;l=o.stateChangedCallback;logger.debug("Universe.play() called with time ["+d+"], speed: ["+a+"]");k();h.play()};this.pause=function(){clearTimeout(e);h.pause()};this.setPlaybackSpeed=function(o){a=o};this.setCurrentUniverseTime=function(o){d=new Date(o);h.updateOnce()};this.getCurrentUniverseTime=function(){return d};this.addJsonGeometryModel=function(q,o,p){logger.debug("Adding mesh model to universe; id: ["+q+"] url: ["+o+"]");if(q!=undefined){m.addGeometryObjectFromUrl(q,o,p)}else{p()}};this.addObject=function(o){h.addGraphicsObject(o)};this.draw=function(q,p,o){c.draw(q,p,o)};this.unDraw=function(o){c.removeObject(o)};this.setObjectInLibrary=function(p,o){m.setObject(p,o)};this.getObjectFromLibraryById=function(p,o){m.getObjectById(p,o)};this.removeObject=function(o){h.removeGraphicsObject(o);c.removeObject(o)};this.snapToObject=function(q){var o=c.getObjectPosition(q);if(o!=undefined){var p=new THREE.Vector3();p.copy(o);p.multiplyScalar(1.4);c.moveCameraTo(p)}else{logger.debug(q+" not added to the core")}};this.removeAll=function(){c.removeAllObjects();h.removeAllGraphicsObjects()};this.getGraphicsObjects=function(){return h.getGraphicsObjects()};this.updateObject=function(q,p,o){};this.showObject=function(p,o){c.showObject(p,o)};this.setup=function(){f()};this.setup()};var SSI=SSI||{};SSI.UniverseController=function(c){var b=new Array();var e;var d=c.refreshRate||30;var a=0;function f(){var j=(new Date()).getTime();var g=j-a;a=j;for(var h in b){b[h].update(g);b[h].draw()}e=setTimeout(function(){f()},d)}this.updateOnce=function(){for(var g in b){b[g].update(null);b[g].draw()}};this.addGraphicsObject=function(g){b[g.id]=g;this.updateOnce()};this.removeGraphicsObject=function(g){delete b[g]};this.play=function(){a=(new Date()).getTime();f()};this.pause=function(){clearTimeout(e)};this.removeAllGraphicsObjects=function(){b=new Array()};this.getGraphicsObjects=function(){return b}};SSI.UniverseController.prototype.changeRefreshRate=function(a){this.refreshRate=a};