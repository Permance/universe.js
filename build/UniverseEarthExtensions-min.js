var Constants={radiusEarth:6378.1363,muEarth:398600.4418,eccEarthSphere:0.081819221456,piOverOneEighty:0.01745329251,oneEightyOverPi:57.295779513};var CoordinateConversionTools={convertCurrentEpochToJulianDate:function(f){var c=0;var e=f.getUTCFullYear();var g=f.getUTCMonth()+1;var b=f.getUTCDate();var a=f.getUTCHours();var h=f.getUTCMinutes();var d=f.getUTCSeconds()+(f.getUTCMilliseconds()/1000);c=367*e-Math.floor((7*(e+Math.floor(((g+9)/12)))/4))+Math.floor((275*g/9))+(b)+1721013.5+((d/60+h)/60+a)/24;return c},convertTimeToGMST:function(d){var c=this.convertCurrentEpochToJulianDate(d);var b=(c-2451545)/36525;var a=67310.54841+(876600*3600+8640184.812866)*b+0.093104*b*b-(0.0000062)*b*b*b;var e=Math.floor(a/86400);a=a-e*86400;a=a/240;if(a<0){a=a+360}return a},convertLLAtoECEF:function(j){var i=MathTools.toRadians(j.getLatitude());var b=MathTools.toRadians(j.getLongitude());var c=Constants.radiusEarth;var m=Constants.eccEarthSphere;var d=Math.sin(i);var g=j.getAltitude();var e=c/Math.sqrt(1-m*m*d*d);var a=c*(1-m*m)/Math.sqrt(1-m*m*d*d);var l=(e+g)*(Math.cos(i)*Math.cos(b));var k=(e+g)*(Math.cos(i)*Math.sin(b));var h=(a+g)*(Math.sin(i));var f=new UNIVERSE.ECEFCoordinates(l,k,h,0,0,0,0,0,0);return f},convertECEFtoLLA:function(a){var j=new UNIVERSE.LLACoordinates();var o=a.getX();var n=a.getY();var m=a.getZ();var k=Constants.eccEarthSphere;var r=Constants.radiusEarth;var w=Math.sqrt((o*o)+(n*n));var i=n/w;var e=o/w;var f=Math.atan(i/e);var l=f;var d=m/w;var v=Math.atan(d);var s=1e-8;var u=0;var g=v;var p=2000;var t;var b;var h=0;while(Math.abs(g-p)>s){p=g;t=Math.sin(p);u=r/Math.sqrt(1-(k*k*t*t));b=(m+u*k*k*t)/w;g=Math.atan(b);h++;if(h>500){g=0;p=0}}if(l<-Math.PI){l=l+2*Math.PI}if(l>Math.PI){l=l-2*Math.PI}j.setLatitude(MathTools.toDegrees(g));j.setLongitude(MathTools.toDegrees(l));j.setAltitude(w/Math.cos(g)-u);return j},convertECItoECEF:function(f,d){var b=new UNIVERSE.ECEFCoordinates();eciPos=new Array();eciPos[0]=f.getX();eciPos[1]=f.getY();eciPos[2]=f.getZ();var a=MathTools.rot3(d,eciPos);b.setX(a[0]);b.setY(a[1]);b.setZ(a[2]);var c=new Array();c[0]=f.getVX();c[1]=f.getVY();c[2]=f.getVZ();a=MathTools.rot3(d,c);b.setVX(a[0]);b.setVY(a[1]);b.setVZ(a[2]);var e=new Array();e[0]=f.getAX();e[1]=f.getAY();e[2]=f.getAZ();a=MathTools.rot3(d,e);b.setAX(a[0]);b.setAY(a[1]);b.setAZ(a[2]);return b},convertECEFtoECI:function(b,d){var f=new UNIVERSE.ECICoordinates();var g=new Array();g[0]=b.getX();g[1]=b.getY();g[2]=b.getZ();var a=MathTools.rot3(-d,g);f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);var c=new Array();c[0]=b.getVX();c[1]=b.getVY();c[2]=b.getVZ();a=MathTools.rot3(-d,c);f.setVX(a[0]);f.setVY(a[1]);f.setVZ(a[2]);var e=new Array();e[0]=b.getAX();e[1]=b.getAY();e[2]=b.getAZ();a=MathTools.rot3(-d,e);f.setAX(a[0]);f.setAY(a[1]);f.setAZ(a[2]);return f},convertECItoLLA:function(c,b){var a=this.convertECItoECEF(c,b);return this.convertECEFtoLLA(a)},convertLLAtoECI:function(b,c){var a=this.convertLLAtoECEF(b);return this.convertECEFtoECI(a,c)},convertKeplerianToECI:function(d){var t=new UNIVERSE.ECICoordinates();var m=d.getSemimajorAxis();var j=d.getEccentricity();var b=m*(1-j*j);var l=d.getTrueAnomaly();var f=Math.cos(MathTools.toRadians(l));var g=Math.sin(MathTools.toRadians(l));var s=b*f/(1+j*f);var k=b*g/(1+j*f);var h=0;var o=new Array();o[0]=s;o[1]=k;o[2]=h;var n=new Array();n=MathTools.rot3(-d.getArgOfPerigee(),o);n=MathTools.rot1(-d.getInclination(),n);n=MathTools.rot3(-d.getRaan(),n);t.setX(n[0]);t.setY(n[1]);t.setZ(n[2]);var i=-Math.sqrt(Constants.muEarth/b)*g;var c=Math.sqrt(Constants.muEarth/b)*(j+f);var r=0;o[0]=i;o[1]=c;o[2]=r;n=MathTools.rot3(-d.getArgOfPerigee(),o);n=MathTools.rot1(-d.getInclination(),n);n=MathTools.rot3(-d.getRaan(),n);t.setVX(n[0]);t.setVY(n[1]);t.setVZ(n[2]);return t},convertECIToKeplerian:function(m){var H=new KeplerianCoordinates();var w=new Array();w[0]=m.x;w[1]=m.y;w[2]=m.z;var s=new Array();s[0]=m.vx;s[1]=m.vy;s[2]=m.vz;var F=MathTools.cross(w,s);var x=MathTools.magnitude(F);var d=MathTools.magnitude(w);var C=MathTools.magnitude(s);var b=new Array();b[0]=0;b[1]=0;b[2]=1;var z=new Array();z=MathTools.cross(b,F);var D=C*C-Constants.muEarth/d;var B=MathTools.dotMultiply(w,s);var J=new Array();var E=0;for(E=0;E<3;E++){J[E]=(1/Constants.muEarth)*(D*w[E]-B*s[E])}var f=MathTools.magnitude(J);var G=C*C/2-Constants.muEarth/d;var y=0;var K=0;if(f==1){K=Infinity;y=x*x/Constants.muEarth}else{K=-Constants.muEarth/(2*G);y=K*(1-f*f)}var o=MathTools.toDegrees(Math.acos(F[2]/x));var k=MathTools.toDegrees(Math.acos(z[0]/MathTools.magnitude(z)));if(z[1]<0){k=360-k}var g=MathTools.toDegrees(Math.acos(MathTools.dotMultiply(z,J)/(MathTools.magnitude(z)*f)));if(J[2]<0){g=360-g}var A=MathTools.dotMultiply(J,w)/(f*d);if(A>1){A=1}var L=MathTools.toDegrees(Math.acos(A));if(MathTools.dotMultiply(s,w)<0){L=360-L}if(isNaN(k)){k=0.00001}if(isNaN(g)){g=0.00001}H.setSemimajorAxis(K);H.setEccentricity(f);H.setTrueAnomaly(L);H.setRaan(k);H.setInclination(o);H.setMeanMotion(MathTools.toDegrees(Math.sqrt(Constants.muEarth/(K*K*K))));H.setArgOfPerigee(g);var t=Math.sin(MathTools.toRadians(L));var j=Math.cos(MathTools.toRadians(L));var u=((t*Math.sqrt(1-f*f))/(1+f*j));var l=((f+j)/(1+f*j));var c=Math.atan2(u,l);var I=c-f*u;I=MathTools.toDegrees(I);H.setMeanAnomaly(I);return H},buildRotationMatrixToConvertECItoRSW:function(e){var f=CoordinateConversionTools.convertECIToKeplerian(e.getEci());var c=f.getTrueAnomaly();var a=f.getArgOfPerigee();var g=f.getInclination();var b=f.getRaan();var h=new Array(3);var d=0;for(var d=0;d<3;d++){h[d]=new Array(3)}h=MathTools.buildRotationMatrix3(b);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix1(g),h);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix3(a),h);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix3(c),h);return h},convertTargetECIToSatelliteRSW:function(i,f){var d=new RSWcoordinates();var e=CoordinateConversionTools.convertECIToKeplerian(i.getEci());var a=i.getEci();var g=e.getTrueAnomaly();var j=e.getArgOfPerigee();var b=e.getInclination();var h=e.getRaan();var c=new Array();c[0]=f.getX()-a.getX();c[1]=f.getY()-a.getY();c[2]=f.getZ()-a.getZ();c=MathTools.rot3(h,c);c=MathTools.rot1(b,c);c=MathTools.rot3(j,c);c=MathTools.rot3(g,c);d.setRadial(c[0]);d.setAlongTrack(c[1]);d.setCrossTrack(c[2]);return d},convertRSWToECI:function(g,d){var j=new UNIVERSE.ECICoordinates();var e=CoordinateConversionTools.convertECIToKeplerian(g.getEci());var f=e.getTrueAnomaly();var i=e.getArgOfPerigee();var b=e.getInclination();var h=e.getRaan();var a=new Array();a[0]=d.getRadial();a[1]=d.getAlongTrack();a[2]=d.getCrossTrack();var c=new Array();c=MathTools.rot3(-f,a);c=MathTools.rot3(-i,c);c=MathTools.rot1(-b,c);c=MathTools.rot3(-h,c);j.setX(c[0]);j.setY(c[1]);j.setZ(c[2]);return j},getSunPositionECIAtCurrentTime:function(d){var f=this.convertCurrentEpochToJulianDate(d);var a=(f-2451545)/36525;var b=280.4606184+36000.77005361*a;var g=357.5277233+35999.05034*a;var c=b+1.914666471*Math.sin(MathTools.toRadians(g))+0.019994643*Math.sin(2*MathTools.toRadians(g));var k=1.000140612-0.016708617*Math.cos(MathTools.toRadians(g))-0.000139589*Math.cos(2*MathTools.toRadians(g));var h=23.439291-0.0130042*a;var j=149597870;var i=new UNIVERSE.ECICoordinates();i.setX(k*Math.cos(MathTools.toRadians(c))*j);i.setY(k*Math.cos(MathTools.toRadians(h))*Math.sin(MathTools.toRadians(c))*j);i.setZ(k*Math.sin(MathTools.toRadians(h))*Math.sin(MathTools.toRadians(c))*j);return i},convertCurrentEpochToBarycentricTime:function(d){var f=new Date(d);var a=new Date(f.getTime()-463);var g=new Date(a.getTime()+32000);var c=new Date(g.getTime()+32184);var b=this.convertCurrentEpochToJulianDate(c);var i=(b-2451545)/36525;var h=new Date(c.getTime()+((0.001658*Math.sin(628.3076*i+6.2401))*1000));var j=this.convertCurrentEpochToJulianDate(h);var e=(j-2451545)/36525;return e},getMoonPositionECIAtCurrentTime:function(c){var a=CoordinateConversionTools.convertCurrentEpochToBarycentricTime(c);var b=218.32+481267.883*a;b+=6.29*Math.sin(MathTools.toRadians(134.9+477198.85*a));b+=-1.27*Math.sin(MathTools.toRadians(259.2-413335.38*a));b+=0.66*Math.sin(MathTools.toRadians(235.7+890534.23*a));b+=0.21*Math.sin(MathTools.toRadians(269.9+954397.7*a));b+=-0.19*Math.sin(MathTools.toRadians(357.5+35999.05*a));b+=-0.11*Math.sin(MathTools.toRadians(186.6+96640.05*a));if(Math.abs(b)>360){b=(b%360)}if(b<0){b+=360}var d=5.13*Math.sin(MathTools.toRadians(93.3+483202.03*a));d+=0.28*Math.sin(MathTools.toRadians(228.2+960400.87*a));d+=-0.28*Math.sin(MathTools.toRadians(318.3+6003.18*a));d+=-0.17*Math.sin(MathTools.toRadians(217.6-407332.2*a));if(Math.abs(d)>360){d=(d%360)}if(d<0){d+=360}var g=0.9508+0.0518*Math.cos(MathTools.toRadians(134.9+477198.85*a));g+=+0.0095*Math.cos(MathTools.toRadians(259.2-413335.38*a));g+=+0.0078*Math.cos(MathTools.toRadians(235.7+890534.23*a));g+=+0.0028*Math.cos(MathTools.toRadians(269.9+954397.7*a));if(Math.abs(g)>360){g=(g%360)}if(g<0){g+=360}var f=23.439291-0.0130042*a;var h=1/Math.sin(MathTools.toRadians(g));h=h*Constants.radiusEarth;f=MathTools.toRadians(f);d=MathTools.toRadians(d);b=MathTools.toRadians(b);moonPosition=new UNIVERSE.ECICoordinates();moonPosition.setX(h*Math.cos(d)*Math.cos(b));moonPosition.setY(h*(Math.cos(f)*Math.cos(d)*Math.sin(b)-Math.sin(f)*Math.sin(d)));moonPosition.setZ(h*(Math.sin(f)*Math.cos(d)*Math.sin(b)+Math.cos(f)*Math.sin(d)));return moonPosition}};var CoordinateFunctionHelper={updateKeplerianAnglesUsingTrueAnomaly:function(c){var a=MathTools.toRadians(trueAnomaly);var d=Math.sin(a)*Math.sqrt(1-c.eccentricity*c.eccentricity)/(1+c.eccentricity*Math.cos(a));var b=(c.eccentricity+Math.cos(a))/(1+c.eccentricity*Math.cos(a));c.eccentricAnomaly=MathTools.toDegrees(Math.atan2(d,b));c.meanAnomaly=MathTools.toDegrees(MathTools.toRadians(c.eccentricAnomaly)-c.eccentricity*d)},setKeplerianTrueAnomaly:function(a,b){a.trueAnomaly=b;updateAnglesUsingTrueAnomaly(a)}};var UNIVERSE=UNIVERSE||{};UNIVERSE.ECEFCoordinates=function(h,f,d,g,c,a,e,b,i){this.x=h?h:0,this.y=f?f:0,this.z=d?d:0,this.vx=g?g:0,this.vy=c?c:0,this.vz=a?a:0,this.ax=e?e:0,this.ay=b?b:0,this.az=i?i:0;this.getX=function(){return this.x};this.setX=function(j){this.x=j};this.getY=function(){return this.y};this.setY=function(j){this.y=j};this.getZ=function(){return this.z};this.setZ=function(j){this.z=j};this.getVX=function(){return this.vx};this.setVX=function(j){this.vx=j};this.getVY=function(){return this.vy};this.setVY=function(j){this.vy=j};this.getVZ=function(){return this.vz};this.setVZ=function(j){this.vz=j};this.getAX=function(){return this.ax};this.setAX=function(j){this.ax=j};this.getAY=function(){return this.ay};this.setAY=function(j){this.ay=j};this.getAZ=function(){return this.az};this.setAZ=function(j){this.az=j}};var UNIVERSE=UNIVERSE||{};UNIVERSE.ECICoordinates=function(h,f,d,g,c,a,e,b,i){this.x=h?h:0,this.y=f?f:0,this.z=d?d:0,this.vx=g?g:0,this.vy=c?c:0,this.vz=a?a:0,this.ax=e?e:0,this.ay=b?b:0,this.az=i?i:0;this.getX=function(){return this.x};this.setX=function(j){this.x=j};this.getY=function(){return this.y};this.setY=function(j){this.y=j};this.getZ=function(){return this.z};this.setZ=function(j){this.z=j};this.getVX=function(){return this.vx};this.setVX=function(j){this.vx=j};this.getVY=function(){return this.vy};this.setVY=function(j){this.vy=j};this.getVZ=function(){return this.vz};this.setVZ=function(j){this.vz=j};this.getAX=function(){return this.ax};this.setAX=function(j){this.ax=j};this.getAY=function(){return this.ay};this.setAY=function(j){this.ay=j};this.getAZ=function(){return this.az};this.setAZ=function(j){this.az=j}};function KeplerianCoordinates(f,g,d,e,a,b,c,i,h){this.semimajorAxis=f?f:0,this.meanAnomaly=g?g:0,this.eccentricAnomaly=g?g:0,this.trueAnomaly=e?e:0,this.inclination=a?a:0,this.eccentricity=b?b:0,this.raan=c?c:0,this.argOfPerigee=i?i:0,this.meanMotion=h?h:0;this.getSemimajorAxis=function(){return this.semimajorAxis};this.getMeanAnomaly=function(){return this.meanAnomaly};this.getEccentricAnomaly=function(){return this.eccentricAnomaly};this.getTrueAnomaly=function(){return this.trueAnomaly};this.getInclination=function(){return this.inclination};this.getEccentricity=function(){return this.eccentricity};this.getRaan=function(){return this.raan};this.getArgOfPerigee=function(){return this.argOfPerigee};this.getMeanMotion=function(){return this.meanMotion};this.setSemimajorAxis=function(j){this.semimajorAxis=j};this.setMeanAnomaly=function(j){this.meanAnomaly=j};this.setEccentricAnomaly=function(j){this.eccentricAnomaly=j};this.setTrueAnomaly=function(j){this.trueAnomaly=j};this.setInclination=function(j){this.inclination=j};this.setEccentricity=function(j){this.eccentricity=j};this.setRaan=function(j){this.raan=j};this.setArgOfPerigee=function(j){this.argOfPerigee=j};this.setMeanMotion=function(j){this.meanMotion=j}}var UNIVERSE=UNIVERSE||{};UNIVERSE.LLACoordinates=function(b,c,a){this.latitude=b?b:0,this.longitude=c?c:0,this.altitude=a?a:0;this.getAltitude=function(){return this.altitude};this.setAltitude=function(d){this.altitude=d};this.getLatitude=function(){return this.latitude};this.setLatitude=function(d){this.latitude=d};this.getLongitude=function(){return this.longitude};this.setLongitude=function(d){this.longitude=d}};var MathTools={scalarMultiply:function(c,d){var f=c.length;var b=new Array();for(var e=0;e<f;e++){b[e]=c[e]*d}return b},scalarMultiplyVector:function(b,c){return{x:b.x*c,y:b.y*c,z:b.z*c}},dotMultiply:function(a,e){if(a.length!=e.length){return 0}else{var d=a.length;var c=0;for(var b=0;b<d;b++){c+=(a[b]*e[b])}return c}},dotMultiplyVector:function(a,c){var b=a.x*c.x+a.y*c.y+a.z*c.z;return b},angleBetweenTwoVectors:function(a,f){var e=0;var d=MathTools.magnitude(a);var c=MathTools.magnitude(f);var b=MathTools.dotMultiply(a,f);e=MathTools.toDegrees(Math.acos(b/(d*c)));if(e>90){e=180-e}return e},magnitude:function(a){var b=0;b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return b},magnitudeVector:function(a){return Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z)},cross:function(b,c){var a=new Array();a[0]=b[1]*c[2]-c[1]*b[2];a[1]=-(b[0]*c[2]-c[0]*b[2]);a[2]=b[0]*c[1]-c[0]*b[1];return a},rot1:function(b,c){b=MathTools.toRadians(b);var a=new Array();a[0]=c[0];a[1]=Math.cos(b)*c[1]+Math.sin(b)*c[2];a[2]=-Math.sin(b)*c[1]+Math.cos(b)*c[2];return a},rot2:function(b,c){b=MathTools.toRadians(b);var a=new Array();a[0]=Math.cos(b)*c[0]-Math.sin(b)*c[2];a[1]=c[1];a[2]=Math.sin(b)*c[0]+Math.cos(b)*c[2];return a},rot3:function(b,c){b=MathTools.toRadians(b);var a=new Array();a[0]=Math.cos(b)*c[0]+Math.sin(b)*c[1];a[1]=-Math.sin(b)*c[0]+Math.cos(b)*c[1];a[2]=c[2];return a},toRadians:function(a){return a*Constants.piOverOneEighty},toDegrees:function(a){return a*Constants.oneEightyOverPi},buildRotationMatrix1:function(b){b=MathTools.toRadians(b);var a=new Array();var c=0;for(c=0;c<3;c++){a[c]=new Array()}a[0][0]=1;a[0][1]=0;a[0][2]=0;a[1][0]=0;a[1][1]=Math.cos(b);a[1][2]=-Math.sin(b);a[2][0]=0;a[2][1]=Math.sin(b);a[2][2]=Math.cos(b);return a},buildRotationMatrix2:function(b){b=MathTools.toRadians(b);var a=new Array();var c=0;for(c=0;c<3;c++){a[c]=new Array()}a[0][0]=Math.cos(b);a[0][1]=0;a[0][2]=Math.sin(b);a[1][0]=0;a[1][1]=1;a[1][2]=0;a[2][0]=-Math.sin(b);a[2][1]=0;a[2][2]=Math.cos(b);return a},buildRotationMatrix3:function(b){b=MathTools.toRadians(b);var a=new Array();var c=0;for(c=0;c<3;c++){a[c]=new Array()}a[0][0]=Math.cos(b);a[0][1]=-Math.sin(b);a[0][2]=0;a[1][0]=Math.sin(b);a[1][1]=Math.cos(b);a[1][2]=0;a[2][0]=0;a[2][1]=0;a[2][2]=1;return a},ones:function(d){var a=new Array();var c=0;var b=0;for(c=0;c<d;c++){result[c]=new Array(d)}for(c=0;c<d;c++){for(b=0;b<d;b++){if(c!=b){a[c][b]=0}else{a[c][b]=1}}}return a},zeros:function(d){var a=new Array(d);var c=0;var b=0;for(c=0;c<d;c++){result[c]=new Array(d)}for(c=0;c<d;c++){for(b=0;b<d;b++){a[c][b]=0}}return a},zeros:function(e,d){var a=new Array(e);var c=0;var b=0;for(c=0;c<e;c++){result[c]=new Array(d)}for(c=0;c<e;c++){for(b=0;b<d;b++){a[c][b]=0}}return a},multiply1dBy2d:function(k,f){var a=k.length;var h=f.length;var g=f[0].length;if(a!=h){return null}var e=new Array(g);for(var d=0;d<g;d++){var b=0;for(var c=0;c<a;c++){b=b+k[c]*f[c][d]}e[d]=b}return e},multiply2dBy1d:function(k,h){var g=k.length;var d=k[0].length;var a=h.length;if(d!=a){return null}var f=new Array(g);for(var e=0;e<g;e++){var b=0;for(var c=0;c<a;c++){b=b+k[e][c]*h[c]}f[e]=b}return f},multiplyDoubleBy2d:function(d,a){var g=a.length;var e=a[0].length;var f=new Array(g);var c=0;var b=0;for(c=0;c<g;c++){f[c]=new Array(e)}for(c=0;c<g;c++){for(b=0;b<e;b++){if(a[c][b]==0){f[c][b]=0}else{f[c][b]=d*a[c][b]}}}return f},multiply2dBy2d:function(n,h){var b=n.length;var a=n[0].length;var m=h.length;var l=h[0].length;if(a!=m){return null}var g=new Array(b);var f=0;var e=0;for(f=0;f<b;f++){g[f]=new Array(l)}for(f=0;f<b;f++){for(e=0;e<l;e++){var c=0;var d=0;for(d=0;d<m;d++){c=c+n[f][d]*h[d][e]}g[f][e]=c}}return g},transposeMatrix:function(a){var d=a.length;var b=a[0].length;var f=new Array(b);var e=0;var c=0;for(e=0;e<b;e++){f[e]=new Array(d)}for(e=0;e<d;e++){for(c=0;c<b;c++){f[c][e]=a[e][c]}}return f},add1dTo1d:function(a,f){var b=a.length;var e=f.length;if(b!=e){return null}var d=new Array(b);var c=0;for(c=0;c<b;c++){d[c]=a[c]+f[c]}return d},add2dTo2d:function(k,f){var b=k.length;var a=k[0].length;var h=f.length;var g=f[0].length;if((b!=h)||(a!=g)){return null}var e=new Array(b);var d=0;var c=0;for(d=0;d<b;d++){e[d]=new Array(a)}for(d=0;d<b;d++){for(c=0;c<a;c++){e[d][c]=k[d][c]+f[d][c]}}return e},subtract2dMinus2d:function(k,f){var b=k.length;var a=k[0].length;var h=f.length;var g=f[0].length;if((b!=h)||(a!=g)){return null}var e=new Array(b);var d=0;var c=0;for(d=0;d<b;d++){e[d]=new Array(a)}for(d=0;d<b;d++){for(c=0;c<a;c++){e[d][c]=k[d][c]-f[d][c]}}return e},subtract1dMinus1d:function(a,f){var b=a.length;var e=f.length;if(b!=e){return null}var d=new Array(b);var c=0;for(c=0;c<b;c++){d[c]=a[c]-f[c]}return d}};function Quaternion(a,d,c,b){this.w=a?a:0,this.x=d?d:0,this.y=c?c:0,this.z=b?b:0,this.q=new Array(4);this.updateQ=function(){this.q[0]=this.w;this.q[1]=this.x;this.q[2]=this.y;this.q[3]=this.z};this.getQ=function(){return q};this.setQ=function(e){this.w=e[0];this.x=e[1];this.y=e[2];this.z=e[3];this.q=e};this.getW=function(){return this.w};this.setW=function(e){this.w=e;this.updateQ()};this.getX=function(){return this.x};this.setX=function(e){this.x=e;this.updateQ()};this.getY=function(){return this.y};this.setY=function(e){this.y=e;this.updateQ()};this.getZ=function(){return this.z};this.setZ=function(e){this.z=e;this.updateQ()};this.isZero=function(){var f=true;var e=0;for(e=0;e<4;e++){if(this.q[e]!=null){if(this.q[e]!=0){f=false;break}}}return f}}var QuaternionMath={multiplyQuaternions:function(h,g){if(h.isZero()){return g}else{if(g.isZero()){return h}else{var f=h.getW();var b=h.getX();var j=h.getY();var d=h.getZ();var e=g.getW();var a=g.getX();var i=g.getY();var c=g.getZ();var k=new Quaternion();k.setW(f*e-b*a-j*i-d*c);k.setX(f*a+b*e+j*c-d*i);k.setY(f*i+j*e+d*a-b*c);k.setZ(f*c+d*e+b*i-j*a);return k}}},applyQuaternionRotation:function(h,c){var j=h.getW();var g=h.getX();var f=h.getY();var e=h.getZ();var b=new Array(3);var d=0;for(d=0;d<3;d++){b[d]=new Array(3)}b[0][0]=2*j*j-1+2*g*g;b[0][1]=2*g*f+2*j*e;b[0][2]=2*g*e-2*j*f;b[1][0]=2*g*f-2*j*e;b[1][1]=2*j*j-1+2*f*f;b[1][2]=2*f*e+2*j*g;b[2][0]=2*g*e+2*j*f;b[2][1]=2*f*e-2*j*g;b[2][2]=2*j*j-1+2*e*e;var a=MathTools.multiply2dBy1d(b,c);return a},getEulerAngles:function(a){var i=a.getW();var g=a.getX();var f=a.getY();var e=a.getZ();var h=Math.atan2((2*(i*g+f*e)),(1-2*(g*g+f*f)));var b=Math.asin(2*(i*f-e*g));var d=Math.atan2((2*(i*e+g*f)),(1-2*(f*f+e*e)));var c=new Array(3);c[0]=MathTools.toDegrees(h);c[1]=MathTools.toDegrees(b);c[2]=MathTools.toDegrees(d);return c},convertRotationMatrixToQuaternion:function(e){var b=new Quaternion();var h=e[0][0];var g=e[0][1];var f=e[0][2];var d=e[1][0];var c=e[1][1];var a=e[1][2];var k=e[2][0];var j=e[2][1];var i=e[2][2];b.setW(0.5*Math.sqrt(h+c+i+1));b.setX((a-j)/(4*b.getW()));b.setY((k-f)/(4*b.getW()));b.setZ((g-d)/(4*b.getW()));return b}};var UNIVERSE=UNIVERSE||{};UNIVERSE.RSWCoordinates=function(a,c,b){this.radial=a?a:0;this.alongTrack=c?c:0;this.crossTrack=b?b:0;this.getRadial=function(){return this.radial};this.setRadial=function(d){this.radial=d};this.getAlongTrack=function(){return this.alongTrack};this.setAlongTrack=function(d){this.alongTrack=d};this.getCrossTrack=function(){return this.crossTrack};this.setCrossTrack=function(d){this.crossTrack=d}};var SimulationObject={name:"",eciCoords:UNIVERSE.ECICoordinates,ecefCoords:UNIVERSE.ECEFCoordinates,keplerCoords:KeplerianCoordinates,llaCoords:UNIVERSE.LLACoordinates,sensorList:new Array(),getEcefCoordinates:function(){return ecefCoords},setEcefCoordinates:function(a){ecefCoords=a},getEciCoordinates:function(){return eciCoords},setEciCoordinates:function(a){eciCoords=a},getKeplerianCoordinates:function(){return keplerCoords},setKeplerianCoordinates:function(a){kepler=a},getLlaCoordinates:function(){return llaCoords},setLlaCoordinates:function(a){lla=a},getName:function(){return name},setName:function(a){this.name=a},getSensors:function(){return sensors},setSensors:function(a){sensorList=a},propagateState:function(f,d,b){eciCoords=OrbitPropagator.propagateOrbit(eci,f,d,b);keplerCoords=CoordinateConversionTools.convertECIToKeplerian(eci);var e=(b.getTime()+(f*1000));var a=new Date(e);var c=CoordinateConversionTools.convertTimeToGMST(a);ecefCoords=CoordinateConversionTools.convertECItoECEF(eci,c);llaCoords=CoordinateConversionTools.convertECItoLLA(eci,c)}};var HarmonicTerms={calculatePerturbationTerms:function(b,a){}};var OrbitPropagator={rungeKuttaFehlbergIntegrator:function(a,o,r,d){var p=a;var z=new Array();var c=new Array();var t=0;var k=1;var x=r;var s=0.02;if(r>s){x=s}var y=d.getTime();k=o/x;var u=1;for(u=1;u<=k;u++){y=y+(x*1000);var w=new Date(y);GST=CoordinateConversionTools.convertTimeToGMST(w);var n=new Array();var m=new Array();var l=new Array();var g=new Array();var e=new Array();var b=new Array();var v=0;for(v=0;v<9;v++){c[v]=p[v]}t=x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){n[v]=x*z[v]}for(v=0;v<9;v++){c[v]=p[v]+0.25*n[v]}t=0.25*x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){m[v]=x*z[v]}for(v=0;v<9;v++){c[v]=p[v]+(3/32)*n[v]+(9/32)*m[v]}t=0.375*x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){l[v]=x*z[v]}for(v=0;v<9;v++){c[v]=p[v]+((1932/2197)*n[v])-((7200/2197)*m[v])+((7296/2197)*l[v])}t=0.9230769230769231*x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){g[v]=x*z[v]}for(v=0;v<9;v++){c[v]=p[v]+((439/216)*n[v])-(8*m[v])+((3680/513)*l[v])-((845/4104)*g[v])}t=x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){e[v]=x*z[v]}for(v=0;v<9;v++){c[v]=p[v]-((8/27)*n[v])+((2)*m[v])-((3544/2565)*l[v])+((1859/4104)*g[v])-((11/40)*e[v])}t=(0.5)*x;z=this.generateStateUpdate(c,t,GST);for(v=0;v<9;v++){b[v]=x*z[v]}for(v=0;v<9;v++){p[v]=p[v]+((16/135)*n[v])+((6656/12825)*l[v])+((28561/56430)*g[v])-((9/50)*e[v])+((2/55)*b[v])}}return p},generateStateUpdate:function(f,e,d){var a=new Array();var b=Constants.muEarth;var c=Math.sqrt((f[0]*f[0])+(f[1]*f[1])+(f[2]*f[2]));a[0]=f[3];a[1]=f[4];a[2]=f[5];a[3]=-b*f[0]/(c*c*c);a[4]=-b*f[1]/(c*c*c);a[5]=-b*f[2]/(c*c*c);a[6]=0;a[7]=0;a[8]=0;return a},propagateOrbit:function(k,o,C,j){var d=CoordinateConversionTools.convertECIToKeplerian(k);if(o==0||isNaN(d.getEccentricity())){return k}else{if(d.getEccentricity()<=0.1){var M=d.getMeanAnomaly()+d.getMeanMotion()*o;var u=MathTools.toRadians(d.getArgOfPerigee());var H=MathTools.toRadians(d.getRaan());var s=MathTools.toRadians(d.getInclination());var v=d.getEccentricity();var D=Constants.muEarth;M=MathTools.toRadians(M);var b=M*0.95;var G=0.00001;for(var I=0;I<500;I++){var a=M-(b-v*Math.sin(b));if(Math.abs(a)>G){if(a>0){b=b+Math.abs(M-b)/2}else{if(a<0){b=b-Math.abs(M-b)/2}}}else{break}}var L=2*Math.atan(Math.sqrt((1+v)/(1-v))*Math.tan(b/2));var E=d.getSemimajorAxis()*(1-v*v);var B=d.getSemimajorAxis()*(1-v*Math.cos(b));var J=Math.sqrt(D*d.getSemimajorAxis()*(1-v*v));var t=B*(Math.cos(H)*Math.cos(u+L)-Math.sin(H)*Math.sin(u+L)*Math.cos(s));var n=B*(Math.sin(H)*Math.cos(u+L)+Math.cos(H)*Math.sin(u+L)*Math.cos(s));var m=B*Math.sin(s)*Math.sin(u+L);var A=((t*J*v)/(B*E))*Math.sin(L)-(J/B)*(Math.cos(H)*Math.sin(u+L)+Math.sin(H)*Math.cos(u+L)*Math.cos(s));var F=((n*J*v)/(B*E))*Math.sin(L)-(J/B)*(Math.sin(H)*Math.sin(u+L)-Math.cos(H)*Math.cos(u+L)*Math.cos(s));var K=((m*J*v)/(B*E))*Math.sin(L)+(J/B)*(Math.sin(s)*Math.cos(u+L));var l=new UNIVERSE.ECICoordinates();l.setX(t);l.setY(n);l.setZ(m);l.setVX(A);l.setVY(F);l.setVZ(K);l.setAX(0);l.setAY(0);l.setAZ(0);return l}else{var g=new Array();g[0]=k.x;g[1]=k.y;g[2]=k.z;g[3]=k.vx;g[4]=k.vy;g[5]=k.vz;g[6]=k.ax;g[7]=k.ay;g[8]=k.az;var e=this.rungeKuttaFehlbergIntegrator(g,o,C,j);var c=new UNIVERSE.ECICoordinates(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]);return c}}}};var UNIVERSE=UNIVERSE||{};UNIVERSE.EllipseSensorShape=function(b,a,c){this.shapeName=b;this.semiMajorAngle=a;this.semiMinorAngle=c;this.getSemiMajorAngle=function(){return this.semiMajorAngle};this.setSemiMajorAngle=function(d){this.semiMajorAngle=d};this.getSemiMinorAngle=function(){return this.semiMinorAngle};this.setSemiMinorAngle=function(d){this.semiMinorAngle=d};this.getAngularExtentOfSensorAtSpecifiedAzimuth=function(g){if((this.semiMajorAngle==0)&&(this.semiMinorAngle==0)){return 0}else{var e=MathTools.toRadians(this.semiMajorAngle);var d=MathTools.toRadians(this.semiMinorAngle);var h=Math.cos(MathTools.toRadians(g));var f=Math.sin(MathTools.toRadians(g));return MathTools.toDegrees(e*d/Math.sqrt((d*h)*(d*h)+(e*f)*(e*f)))}};this.canSensorSeePointAtAzEl=function(f,g){var e=false;var d=this.getAngularExtentOfSensorAtSpecifiedAzimuth(f);console.log("ellipseSensor canSensorSee:  radius sensor: "+d+"    relative radius: "+g);if(d>g){e=true}return e}};var UNIVERSE=UNIVERSE||{};UNIVERSE.GroundObject=function(d,c,b,a){if(d==undefined){return undefined}this.id=d;this.objectName=c||d;this.propagator=a;this.modelId=b};UNIVERSE.GroundObject.prototype={constructor:UNIVERSE.GroundObject,set:function(d,c,a,b){this.id=d;this.objectName=c||d;this.propagator=a;this.modelId=b;return this}};var UNIVERSE=UNIVERSE||{};UNIVERSE.RectangleSensorShape=function(b,c,a){this.shapeName=b;this.width=c;this.height=a;this.getHeight=function(){return this.height};this.setHeight=function(d){this.height=d};this.getWidth=function(){return this.width};this.setWidth=function(d){this.width=d};this.getAngularExtentOfSensorAtSpecifiedAzimuth=function(i){if((this.height==0)&&(this.width==0)){return 0}else{var f=MathTools.toDegrees(Math.atan(this.height/this.width));var j=180-f;var d=180+f;var h=360-f;if(i<0){i+=360}var g=Math.abs(this.width/(2*Math.cos(MathTools.toRadians(i))));var e=Math.abs(this.height/(2*Math.sin(MathTools.toRadians(i))));if(i<f){return g}else{if(i<j){return e}else{if(i<d){return g}else{if(i<h){return e}else{return g}}}}}};this.canSensorSeePointAtAzEl=function(f,g){var e=false;var d=this.getAngularExtentOfSensorAtSpecifiedAzimuth(f);console.log("rectSensor canSensorSee:  radius sensor: "+d+"    relative radius: "+g);if(d>g){e=true}return e}};var UNIVERSE=UNIVERSE||{};UNIVERSE.Sensor=function(b,a){this.name=b;this.shape=a;this.quaternionFromRSWToSensor=new Quaternion();this.rotationRadians=MathTools.toRadians(180);this.rotationAxis=new Array();this.rotationAxis[0]=0;this.rotationAxis[1]=0;this.rotationAxis[2]=1;this.quaternionFromRSWToSensor.setW(Math.cos(this.rotationRadians/2));this.quaternionFromRSWToSensor.setX(Math.sin(this.rotationRadians/2)*this.rotationAxis[0]);this.quaternionFromRSWToSensor.setY(Math.sin(this.rotationRadians/2)*this.rotationAxis[1]);this.quaternionFromRSWToSensor.setZ(Math.sin(this.rotationRadians/2)*this.rotationAxis[2]);this.rotateSensorAboutRadialVector=function(f){if(f&&f!=0){var e=new Quaternion();var c=MathTools.toRadians(f);var d=new Array();d[0]=1;d[1]=0;d[2]=0;e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d[0]);e.setY(Math.sin(c/2)*d[1]);e.setZ(Math.sin(c/2)*d[2]);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.rotateSensorAboutAlongTrackVector=function(f){if(f&&f!=0){var e=new Quaternion();var c=MathTools.toRadians(f);var d=new Array();d[0]=0;d[1]=1;d[2]=0;e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d[0]);e.setY(Math.sin(c/2)*d[1]);e.setZ(Math.sin(c/2)*d[2]);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.rotateSensorAboutCrossTrackVector=function(f){if(f&&f!=0){var e=new Quaternion();var c=MathTools.toRadians(f);var d=new Array();d[0]=0;d[1]=0;d[2]=1;e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d[0]);e.setY(Math.sin(c/2)*d[1]);e.setZ(Math.sin(c/2)*d[2]);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.getSensorQuaternionRSW=function(){return this.quaternionFromRSWToSensor};this.setSensorQuaternionRSW=function(c){this.quaternionFromRSWToSensor=c};this.getName=function(){return this.name};this.setName=function(c){this.name=c};this.getShape=function(){return this.shape};this.setShape=function(c){this.shape=c};this.determineTargetAzElRelativeToSensor=function(p,j){var f=new Array();console.log("satellite: "+p.getEci().getX()+", "+p.getEci().getY()+", "+p.getEci().getZ()+"      targetpos: "+j.getX()+", "+j.getY()+", "+j.getZ());var r=new Array();r[0]=j.getX()-p.getEci().getX();r[1]=j.getY()-p.getEci().getY();r[2]=j.getZ()-p.getEci().getZ();var h=QuaternionMath.convertRotationMatrixToQuaternion(CoordinateConversionTools.buildRotationMatrixToConvertECItoRSW(p));var k=QuaternionMath.applyQuaternionRotation(QuaternionMath.multiplyQuaternions(h,this.quaternionFromRSWToSensor),r);r[0]=k[0];r[1]=k[1];r[2]=k[2];var n=new Array();n[0]=1;n[1]=0;n[2]=0;var v=new Array();v[0]=1;v[1]=-Math.tan(MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(0)));v[2]=0;var o=new Array();o[0]=1;o[1]=0;o[2]=Math.tan(MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(90)));var y=MathTools.toRadians(MathTools.angleBetweenTwoVectors(n,v));var x=MathTools.toRadians(MathTools.angleBetweenTwoVectors(n,r));var w=MathTools.toRadians(MathTools.angleBetweenTwoVectors(v,r));var u=MathTools.toRadians(MathTools.angleBetweenTwoVectors(o,r));var t=MathTools.toRadians(MathTools.angleBetweenTwoVectors(o,n));var l=0.5*(y+x+w);var m=2*Math.asin(Math.sqrt((Math.sin(l-y)*Math.sin(l-x)/(Math.sin(y)*Math.sin(x)))));var i=MathTools.toDegrees(m);var g=MathTools.toDegrees(x);if(u>x&&u>t){i=360-i}f[0]=i;f[1]=g;return f};this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTarget=function(l,h){var e=false;var f=new Array();var d=new Array();var g=Constants.radiusEarth;f[0]=l.getEci().getX()/g;f[1]=l.getEci().getY()/g;f[2]=l.getEci().getZ()/g;d[0]=h.getX()/g;d[1]=h.getY()/g;d[2]=h.getZ()/g;var k=MathTools.magnitude(f);var j=MathTools.magnitude(d);var c=0.5;var i=0;if(k<1||j<1){e=false}else{c=(k*k-MathTools.dotMultiply(f,d))/(k*k+j*j-2*MathTools.dotMultiply(f,d));if(c<0||c>1){e=true}else{i=(1-c)*k*k+MathTools.dotMultiply(f,d)*c;if(i>=1){e=true}}}return !e};this.checkSensorVisibilityOfTargetPoint=function(d,e){var f=this.determineTargetAzElRelativeToSensor(d,e);console.log("az: "+f[0]+" el: "+f[1]+" shape El extent: "+this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(f[0]));var c=this.shape.canSensorSeePointAtAzEl(f[0],f[1]);var g=this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTarget(d,e);console.log("earth obscured:"+g+"    inFOV:"+c);if(g){return false}else{if(c==true&&g==false){return true}else{return false}}};this.buildPointsToDefineSensorShapeInECI=function(n,l){var r=new Array(n);for(var h=0;h<n;h++){r[h]=new Array(3)}var c=360/n;for(var h=0;h<n;h++){var o=h*c;var d=MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(o));var f=new Array(3);f[0]=1;f[1]=d*Math.cos(MathTools.toRadians(o));f[2]=d*Math.sin(MathTools.toRadians(o));var m=MathTools.magnitude(f);f[0]=f[0]/m;f[1]=f[1]/m;f[2]=f[2]/m;f=QuaternionMath.applyQuaternionRotation(this.quaternionFromRSWToSensor,f);var p=new UNIVERSE.RSWCoordinates(f[0],f[1],f[2]);var k=l.getEci().getX();var j=l.getEci().getY();var e=l.getEci().getZ();var g=CoordinateConversionTools.convertRSWToECI(l,p);r[h][0]=k+g.getX();r[h][1]=j+g.getY();r[h][2]=e+g.getZ()}return r};this.findProjectionPoints=function(m,A,F){var t={x:A.getEci().getX(),y:A.getEci().getY(),z:A.getEci().getZ()};var g={x:-t.x,y:-t.y,z:-t.z};var v=new Array();var K=m.length;for(var D=0;D<K;D++){var s={x:m[D][0]-t.x,y:m[D][1]-t.y,z:m[D][2]-t.z};var B=MathTools.magnitudeVector(t);var L=B+F;var o=s;var J=g;var k=200;var w=Constants.radiusEarth+k;var z=MathTools.dotMultiplyVector(o,J);var C=MathTools.dotMultiplyVector(J,J);var f=z*z-C+w*w;if(f>=0){var u=Math.sqrt(z*z-C+w*w);var E=z+u;var e=z-u;var d={x:s.x*e+t.x,y:s.y*e+t.y,z:s.z*e+t.z};if(d.x!=null){v.push(d)}}else{var y=MathTools.scalarMultiplyVector(s,L);var M=MathTools.scalarMultiplyVector(g,1/B);var H=Math.acos(MathTools.dotMultiplyVector(s,M));var x=B*Math.sin(H);var n=x/Math.atan(H);var l=n/L;var j={x:(y.x)*l+t.x,y:(y.y)*l+t.y,z:(y.z)*l+t.z};var G=MathTools.magnitudeVector(j);var h=(Constants.radiusEarth+k)/G;var p=MathTools.scalarMultiplyVector(j,h);v.push(p)}}return v};this.extendSensorEndpointsInECIToConformToEarth=function(h,w,D,A){var H=new Array(h.length);var d=h.length;for(var B=0;B<d;B++){H[B]=new Array(3)}var r=w.getEci().getX();var n=w.getEci().getY();var m=w.getEci().getZ();var J=Math.sqrt(r*r+n*n+m*m)+D;for(var B=0;B<d;B++){var I=r+(h[B][0]-r)*J;var G=n+(h[B][1]-n)*J;var F=m+(h[B][2]-m)*J;var s=new UNIVERSE.ECICoordinates(I,G,F,0,0,0,0,0,0);var g=this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTarget(w,s);if(g==false){H[B][0]=I;H[B][1]=G;H[B][2]=F}else{var l=Constants.radiusEarth;var v=1000000;var e=J;var C=0.5;var k=0;while(Math.abs(v)>A){var j=r+(I-r)*C;var p=n+(F-n)*C;var u=m+(F-m)*C;var t=Math.sqrt(j*j+p*p+u*u);v=l-t;k++;if(k>50){break}if(v>0){C=C-0.95*Math.abs(v)/e}else{if(v<0){C=C+1.05*Math.abs(v)/e}else{break}}}if(v>0){C=C-1.05*Math.abs(v)/e}var o=r+(I-r)*C;var E=n+(F-n)*C;var f=m+(F-m)*C;H[B][0]=o;H[B][1]=E;H[B][2]=f;var c=Math.sqrt(o*o+E*E+f*f);v=l-c}}return H};this.getQuaternionFromECIToSensor=function(m,o){var i=MathTools.magnitude(m);var d=new Array(3);d[0]=m[0]/i;d[1]=m[1]/i;d[2]=m[2]/i;var r=new Array(3);var n=o.getEci().getX();var l=o.getEci().getY();var j=o.getEci().getZ();var p=Math.sqrt(n*n+l*l+j*j);r[0]=n/p;r[1]=l/p;r[2]=j/p;var k=new Quaternion();var c=MathTools.toRadians(180);var h=new Array();h[0]=0;h[1]=0;h[2]=1;k.setW(Math.cos(c/2));k.setX(Math.sin(c/2)*h[0]);k.setY(Math.sin(c/2)*h[1]);k.setZ(Math.sin(c/2)*h[2]);var g=MathTools.cross(d,r);var f=MathTools.magnitude(g);var e=new Quaternion();e.setX(g[0]/f);e.setY(g[1]/f);e.setZ(g[2]/f);e.setW(Math.acos(MathTools.dotMultiply(d,r)));var s=QuaternionMath.multiplyQuaternions(e,k);s=QuaternionMath.multiplyQuaternions(s,this.quaternionFromRSWToSensor);return s}};var UNIVERSE=UNIVERSE||{};UNIVERSE.SpaceObject=function(g,f,e,c,b,a,d){if(g==undefined){return undefined}this.id=g;this.objectName=f||g;this.propagator=c;this.modelId=e;this.showPropagationLine=b||false;this.showGroundTrackPoint=a||false;this.sensors=d||undefined};UNIVERSE.SpaceObject.prototype={constructor:UNIVERSE.SpaceObject,set:function(g,f,c,e,b,a,d){this.id=g;this.objectName=f||g;this.propagator=c;this.modelId=e;this.showPropagationLine=showPropagationLine||false;this.showGroundTrackPoint=a||false;this.sensors=d||undefined;return this},getEci:function(){var a=this.propagator();return new UNIVERSE.ECICoordinates(a.x,a.y,a.z,a.vx,a.vy,a.vz,a.ax,a.ay,a.az)}};var UNIVERSE=UNIVERSE||{};UNIVERSE.EarthExtensions=function(d,i){var c=this;var j=6371;var f=new THREE.Vector3(0,0,0);var g=undefined;var a=i?i:true;d.setObjectInLibrary("default_ground_object_geometry",new THREE.SphereGeometry(200,20,10));d.setObjectInLibrary("default_ground_object_material",new THREE.MeshLambertMaterial({color:13369344}));d.setObjectInLibrary("default_ground_track_material",new THREE.MeshBasicMaterial({color:13369344,transparent:true,opacity:0.4,blending:THREE.AdditiveBlending}));var b={colorList:["0xff0000","0x00cc00","0x0066ff","0x9900cc","0xffff00","0xff6666","0xebebeb","0xffaa00"],iterator:-1,nextColor:function(){this.iterator=(this.iterator+1)%this.colorList.length;return this.colorList[this.iterator]}};d.setObjectInLibrary("default_orbit_line_material",new THREE.LineBasicMaterial({color:10027008,opacity:1}));d.setObjectInLibrary("default_ground_object_tracing_line_material",new THREE.LineBasicMaterial({color:39168,opacity:1}));this.addEarth=function(n,u){var t=40,s=30;var w=new THREE.SphereGeometry(j,t,s);var x=THREE.ImageUtils.loadTexture(n);var o=THREE.ImageUtils.loadTexture(u);var y=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:o,blending:THREE.AdditiveBlending});var p=new THREE.Mesh(w,y);var m=new THREE.MeshPhongMaterial({map:x,color:16777215,transparent:true,blending:THREE.AdditiveBlending});var l=new THREE.Mesh(w,m);var r=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:x,blending:THREE.AdditiveBlending});var k=new THREE.Mesh(w,r);var v=new UNIVERSE.GraphicsObject("earth","earth",{x:0,y:0,z:0},function(z){var A=CoordinateConversionTools.convertTimeToGMST(d.getCurrentUniverseTime());l.rotation.y=A*(2*Math.PI/360);p.rotation.y=A*(2*Math.PI/360);k.rotation.y=A*(2*Math.PI/360)},function(){d.draw(this.id+"_day",l,false);d.draw(this.id+"_night",p,false);d.draw(this.id,k,false);c.useSunLighting(a)});d.addObject(v)};this.addMoon=function(t){var u=40,l=30;var o=1737.1;var s=new THREE.SphereGeometry(o,u,l);var r=THREE.ImageUtils.loadTexture(t);var m=new THREE.MeshPhongMaterial({map:r,color:16777215,transparent:true,blending:THREE.AdditiveBlending});var n=new THREE.Mesh(s,m);var v=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:r,blending:THREE.AdditiveBlending});var p=new THREE.Mesh(s,v);var k=new UNIVERSE.GraphicsObject("moon","moon",undefined,function(w){var z=new Date(d.getCurrentUniverseTime());var y=CoordinateConversionTools.getMoonPositionECIAtCurrentTime(z);var x=h({x:y.x,y:y.y,z:y.z});n.position={x:x.x,y:x.y,z:x.z};p.position={x:x.x,y:x.y,z:x.z};this.currentLocation={x:x.x,y:x.y,z:x.z}},function(){d.draw(this.id+"_day",n,false);d.draw(this.id,p,false);c.useSunLighting(a)});d.addObject(k)};this.addSun=function(){var k=new UNIVERSE.GraphicsObject("sun","sun",undefined,function(l){var n=CoordinateConversionTools.getSunPositionECIAtCurrentTime(d.getCurrentUniverseTime());var m=h({x:n.x,y:n.y,z:n.z});d.updateLight(m.x,m.y,m.z,1.5);this.currentLocation={x:m.x,y:m.y,z:m.z}},function(){d.draw(this.id,undefined,false)});d.addObject(k)};this.addSpaceObject=function(m){var l,k;d.getObjectFromLibraryById(m.modelId,function(n){l=n;d.getObjectFromLibraryById("default_material",function(o){k=o;var p=new THREE.Mesh(l,k);var r=new UNIVERSE.GraphicsObject(m.id,m.objectName,undefined,function(s){var t=h(m.propagator());if(t!=undefined){p.position.set(t.x,t.y,t.z);p.lookAt(f);this.currentLocation={x:t.x,y:t.y,z:t.z}}},function(){d.draw(this.id,p,false);c.showModelForId(m.showVehicle,this.id)});d.addObject(r);c.addPropogationLineForObject(m);c.showOrbitLineForObject(m.showPropogationLine,m.id);c.addGroundTrackPointForObject(m);c.showGroundTrackForId(m.showGroundTrackPoint,m.id);c.addSensorProjections(m);c.showSensorProjectionForId(m.showSensorProjections,m.id);c.addSensorFootprintProjections(m);c.showSensorFootprintProjectionsForId(m.showSensorFootprintProjections,m.id)})})};this.addGroundObject=function(l){var n,k,m;if(!l.modelId){l.modelId="default_ground_object_geometry";m="default_ground_object_material"}else{m="default_material"}d.getObjectFromLibraryById(l.modelId,function(o){n=o;d.getObjectFromLibraryById(m,function(r){k=r;n.applyMatrix(new THREE.Matrix4().setRotationFromEuler(new THREE.Vector3(Math.PI/2,Math.PI,0)));var p=new THREE.Mesh(n,k);var s=new UNIVERSE.GraphicsObject(l.id,l.objectName,undefined,function(v){var u=h(l.propagator());p.position.set(u.x,u.y,u.z);this.currentLocation={x:u.x,y:u.y,z:u.z};var t=new THREE.Vector3(u.x,u.y,u.z);t.multiplyScalar(1.4);p.lookAt(t)},function(){d.draw(this.id,p,true)});d.addObject(s)})})};this.addGroundTrackPointForObject=function(l){var m,k;d.getObjectFromLibraryById("default_ground_object_geometry",function(n){m=n;d.getObjectFromLibraryById("default_ground_track_material",function(p){k=p;var o=new THREE.Mesh(m,k);var r=new UNIVERSE.GraphicsObject(l.id+"_groundPoint",l.objectName,undefined,function(t){var u=h(l.propagator(undefined,false));if(u!=undefined){var s=new THREE.Vector3(u.x,u.y,u.z);s.multiplyScalar(j/s.length());o.position.copy(s)}this.currentLocation=u},function(){d.draw(this.id,o,true)});d.addObject(r)})})};this.addPropogationLineForObject=function(l){var m,k;m=new THREE.Geometry();d.getObjectFromLibraryById("default_orbit_line_material",function(s){k=s;var v=new Date(d.getCurrentUniverseTime());var p=1440;for(var r=0;r<p;r+=5){var u=h(l.propagator(v,false));if(u!=undefined){var o=new THREE.Vector3(u.x,u.y,u.z);m.vertices.push(new THREE.Vertex(o))}v.setMinutes(v.getMinutes()+5)}var n=new THREE.Line(m,k);var t=new UNIVERSE.GraphicsObject(l.id+"_propogation",l.objectName,undefined,function(w){},function(){d.draw(this.id,n,false)});d.addObject(t)})};this.addSensorProjection=function(m,r){var n,x;var o=h(r.propagator(undefined,false));if(o!=undefined){var l=30;var w=m.buildPointsToDefineSensorShapeInECI(l,r);var v=m.findProjectionPoints(w,r,1000);var k=new Array(v.length);var u=v.length;for(var p=0;p<u;p++){var s=h(v[p]);k[p]=s}n=new SensorProjection(o,k);var x=new THREE.MeshBasicMaterial({color:b.nextColor(),transparent:true,blending:THREE.AdditiveBlending,opacity:0.15,overdraw:true});var y=new THREE.Mesh(n,x);y.doubleSided=true;var t=new UNIVERSE.GraphicsObject(r.id+"_sensorProjection_"+m.name,r.objectName,undefined,function(z){var D=h(r.propagator(undefined,false));if(D!=undefined){var B=m.buildPointsToDefineSensorShapeInECI(l,r);var C=m.findProjectionPoints(B,r,1000);k=[];for(var A=0;A<u;A++){var E=h(C[A]);k[A]=E}y.geometry.recalculateVertices(D,k)}},function(){d.draw(this.id,y,false)});d.addObject(t)}};this.addSensorProjections=function(l){if(l.sensors.length>0){for(var k=l.sensors.length-1;k>=0;k--){this.addSensorProjection(l.sensors[k],l)}}};this.addSensorFootprintProjections=function(l){if(l.sensors.length>0){for(var k=0;k<l.sensors.length;k++){this.addSensorFootprintProjection(l.sensors[k],l)}}};this.addSensorFootprintProjection=function(k,o){var t=new THREE.LineBasicMaterial({color:e(),opacity:0.5,linewidth:3});var m=new THREE.Geometry();var s=k.buildPointsToDefineSensorShapeInECI(40,o);var r=k.findProjectionPoints(s,o,1000);for(var n=0;n<r.length;n++){var l=new THREE.Vector3(-r[n].x,r[n].z,r[n].y);m.vertices.push(new THREE.Vertex(l))}m.vertices.push(new THREE.Vertex(new THREE.Vector3(-r[0].x,r[0].z,r[0].y)));var u=new THREE.Line(m,t);var p=new UNIVERSE.GraphicsObject(o.id+"_footprint_"+k.name,undefined,undefined,function(w){var x=this.sensor.buildPointsToDefineSensorShapeInECI(40,o);var y=this.sensor.findProjectionPoints(x,o,1000);for(var v=0;v<y.length;v++){u.geometry.vertices[v].position={x:-y[v].x,y:y[v].z,z:y[v].y}}u.geometry.vertices[y.length].position={x:-y[0].x,y:y[0].z,z:y[0].y};u.geometry.__dirtyVertices=true},function(){d.draw(this.id,u,false)});p.sensor=k;d.addObject(p)};this.addClosestGroundObjectTracingLine=function(k){var m=undefined;var l=new UNIVERSE.GraphicsObject(k.id+"_controlLine",k.objectName,undefined,function(n){var p=h(k.propagator(undefined,false));var o=c.findClosestGroundObject(p);if(o!=undefined&&o.id!=m){c.removeLineBetweenObjects(k.id,m);m=o.id;c.addLineBetweenObjects(k.id,m)}},function(){});d.addObject(l)};this.addLineBetweenObjects=function(o,n,l){var m,k;d.getObjectFromLibraryById("default_ground_object_tracing_line_material",function(r){if(l){k=new THREE.LineBasicMaterial({color:l,opacity:1})}else{k=r}var u=d.getGraphicsObjectById(o);var t=d.getGraphicsObjectById(n);if(u==undefined||t==undefined){return}var w=u.currentLocation;var v=t.currentLocation;if(w==undefined||v==undefined){return}m=new THREE.Geometry();m.vertices.push(new THREE.Vertex(new THREE.Vector3(w.x,w.y,w.z)));m.vertices.push(new THREE.Vertex(new THREE.Vector3(v.x,v.y,v.z)));var p=new THREE.Line(m,k);var s=new UNIVERSE.GraphicsObject(o+"_to_"+n,undefined,undefined,function(x){var z=d.getGraphicsObjectById(o);var y=d.getGraphicsObjectById(n);if(z==undefined||y==undefined){return}var B=z.currentLocation;var A=y.currentLocation;if(B==undefined||A==undefined){return}m.vertices[0].position={x:B.x,y:B.y,z:B.z};m.vertices[1].position={x:A.x,y:A.y,z:A.z};m.__dirtyVertices=true},function(){d.draw(this.id,p,false)});d.addObject(s)})};this.removeLineBetweenObjects=function(l,k){d.removeObject(l+"_to_"+k)};this.removeAllLinesBetweenObjects=function(){var k=d.getGraphicsObjects();for(var l in k){if(l.indexOf("_to_")>-1){d.removeObject(l)}}};this.findClosestGroundObject=function(k){if(k!=undefined){var l=new THREE.Vector3(k.x,k.y,k.z);l.multiplyScalar(j/l.length());return c.findClosestObject({x:l.x,y:l.y,z:l.z})}return undefined};this.findClosestObject=function(l){var m=d.getGraphicsObjects();var s=undefined;var p=undefined;var o=new THREE.Vector3(l.x,l.y,l.z);for(var n in m){if(m[n].currentLocation!=undefined){var k=new THREE.Vector3(m[n].currentLocation.x,m[n].currentLocation.y,m[n].currentLocation.z);var r=k.distanceTo(o);if(s==undefined||r<s){p=m[n];s=r}}}return p};this.showAllOrbitLines=function(m){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf("_propogation")!=-1){d.showObject(k[l].id,m)}}};this.showOrbitLineForObject=function(k,l){d.showObject(l+"_propogation",k)};this.showModelForId=function(k,l){d.showObject(l,k)};this.showAllGroundTracks=function(m){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf("_groundPoint")!=-1){d.showObject(k[l].id,m)}}};this.showGroundTrackForId=function(k,l){d.showObject(l+"_groundPoint",k)};this.showAllSensorProjections=function(m){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf("_sensorProjection")!=-1){d.showObject(k[l].id,m)}}};this.showSensorProjectionForId=function(k,l){d.showObject(l+"_sensorProjection",k)};this.showAllSensorFootprintProjections=function(m){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf("_footprint")!=-1){d.showObject(k[l].id,m)}}};this.showSensorFootprintProjectionsForId=function(m,n){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf(n)!=-1&&k[l].id.indexOf("_footprint")!=-1){d.showObject(k[l].id,m)}}};this.showAllLinesBetweenObjects=function(m){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf("_to_")!=-1){d.showObject(k[l].id,m)}}};this.showLineBetweenObjectsForId=function(m,n){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id.indexOf(n+"_to_")!=-1||k[l].id.indexOf("_to_"+n)!=-1){d.showObject(k[l].id,m)}}};this.useSunLighting=function(k){a=k;d.showObject("earth",!k);d.showObject("earth_day",k);d.showObject("earth_night",k)};this.removeAllExceptEarthAndMoon=function(){var k=d.getGraphicsObjects();for(var l in k){if(k[l].id!="earth"&&k[l].id!="moon"&&k[l].id!="sun"){d.removeObject(k[l].id)}}};this.setup=function(){this.removeAllExceptEarthAndMoon();d.setup()};function h(k){if(k==undefined){return undefined}return{x:-k.x,y:k.z,z:k.y}}function e(){var m="0123456789ABCDEF".split("");var k="0x";for(var l=0;l<6;l++){k+=m[Math.round(Math.random()*15)]}return k}};