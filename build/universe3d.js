var SSI=SSI||{};SSI.Core3D=function(a){function x(){f=a.offsetWidth||window.innerWidth,g=a.offsetHeight||window.innerHeight,y(),b=new THREE.PerspectiveCamera(30,f/g,1,1e6),b.position.z=q,h=new THREE.Vector3,c=new THREE.Scene,z(),i()}function y(){d=new THREE.Projector,e=new THREE.WebGLRenderer({antialias:!0}),e.autoClear=!1,e.setClearColorHex(0,0),e.setSize(f,g),e.domElement.style.position="absolute",a.appendChild(e.domElement)}function z(){a.addEventListener("mousedown",C,!1),a.addEventListener("mousewheel",G,!1),a.addEventListener("DOMMouseScroll",H,!1),document.addEventListener("keydown",I,!1),window.addEventListener("resize",J,!1),a.addEventListener("mouseover",function(){j=!0},!1),a.addEventListener("mouseout",function(){j=!1},!1)}function i(){requestAnimationFrame(i),A()}function A(){L(k),n.x+=(o.x-n.x)*.1,n.y+=(o.y-n.y)*.1,q+=(r-q)*.3,b.position.x=q*Math.sin(n.x)*Math.cos(n.y),b.position.y=q*Math.sin(n.y),b.position.z=q*Math.cos(n.x)*Math.cos(n.y),b.lookAt(c.position),h.copy(b.position),B(),e.clear(),e.render(c,b)}function B(){for(var a in v)if(v[a].scale==1){var c=v[a].shape.position,d=c.x-b.position.x,e=c.y-b.position.y,f=c.z-b.position.z,g=Math.sqrt(d*d+e*e+f*f),h=g/44597;v[a].shape.scale.x=v[a].shape.scale.y=v[a].shape.scale.z=h}}function C(b){b.preventDefault(),a.addEventListener("mousemove",D,!1),a.addEventListener("mouseup",E,!1),a.addEventListener("mouseout",F,!1),m.x=-b.clientX,m.y=b.clientY,p.x=o.x,p.y=o.y,a.style.cursor="move"}function D(a){l.x=-a.clientX,l.y=a.clientY;var b=q/35e3;o.x=p.x+(l.x-m.x)*.005*b,o.y=p.y+(l.y-m.y)*.005*b,o.y=o.y>s?s:o.y,o.y=o.y<-s?-s:o.y}function E(b){b.preventDefault(),a.removeEventListener("mousemove",D,!1),a.removeEventListener("mouseup",E,!1),a.removeEventListener("mouseout",F,!1),a.style.cursor="auto"}function F(b){a.removeEventListener("mousemove",D,!1),a.removeEventListener("mouseup",E,!1),a.removeEventListener("mouseout",F,!1)}function G(a){return a.preventDefault(),j&&L(a.wheelDeltaY*10),!1}function H(a){a.preventDefault();if(j){var b=a.detail?a.detail*-120:a.wheelDelta;L(b*10)}return!1}function I(a){switch(a.keyCode){case 38:L(3200),a.preventDefault();break;case 40:L(-3200),a.preventDefault()}}function J(a){clearTimeout(w),w=setTimeout(function(){K()},250)}function K(){logger.debug("resize"),f=a.offsetWidth||window.innerWidth,g=a.offsetHeight||window.innerHeight,b.aspect=f/g,b.updateProjectionMatrix(),e.setSize(f,g)}function L(a){r-=a,r=r>t?t:r,r=r<u?u:r}var b,c,d,e,f,g,h,i,j,k=0,l={x:0,y:0},m={x:0,y:0},n={x:0,y:0},o={x:Math.PI*3/2,y:Math.PI/6},p={x:0,y:0},q=5e4,r=5e4,s=Math.PI/2,t=5e5,u=1e4,v=new Array,w=null;return this.draw=function(a,b,d){v[a]==undefined&&(logger.debug(" adding and drawing: "+a),c.add(b),v[a]={shape:b,scale:d})},this.showObject=function(a,b){v[a]!=undefined&&(b?(logger.debug("adding shape back to scene for id "+a),c.add(v[a].shape)):(logger.debug("removing object from scene with id: "+a),c.remove(v[a].shape)))},this.removeObject=function(a){v[a]!=undefined&&(c.remove(v[a].shape),delete v[a])},this.removeAllObjects=function(){for(var a in v)c.remove(v[a].shape);v=new Array},this.getObjectPosition=function(a){return v[a]==undefined?undefined:v[a].shape.position},this.moveCameraTo=function(a){logger.debug("Moving camera to: "+JSON.stringify(a)),r=a.length();var b=new THREE.Vector3(0,0,1),c=new THREE.Vector3(0,1,0),d=new THREE.Vector3;d.copy(a),d.y=0,d.normalize(),a.normalize();var e=Math.PI/2-Math.acos(c.dot(a)),f=Math.acos(b.dot(d));d.x<0&&(f=-f),o.y=isNaN(e)?0:e,o.x=isNaN(f)?0:f,logger.debug("target: "+JSON.stringify(o))},x(),this};